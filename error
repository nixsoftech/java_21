---
- name: Upgrade Ubuntu 18.04 to 22.04 using private mirrors with robust SSH and logging
  hosts: all
  become: true
  vars:
    reboot_wait_timeout: 3600        # 1 hour wait for reboot
    script_execution_timeout: 14400  # 4 hours for long-running upgrade
    log_dir: "{{ playbook_dir }}/upgrade-logs/{{ inventory_hostname }}"

    # Private mirrors
    mirror_amd64: "http://10.13.0.88:8080/ubuntu"
    mirror_i386: "http://10.13.0.90/ubuntu/ubuntu"

    # Ubuntu versions
    ubuntu_current: "bionic"
    ubuntu_next1: "focal"
    ubuntu_next2: "jammy"

    repo_content: |
      # Private Repository
      deb [arch=amd64] {{ mirror_amd64 }} {{ ubuntu_current }} main universe
      deb [arch=amd64] {{ mirror_amd64 }} {{ ubuntu_current }}-updates main universe
      deb [arch=amd64] {{ mirror_amd64 }} {{ ubuntu_current }}-security main universe
      deb [arch=amd64] {{ mirror_i386 }} {{ ubuntu_current }} restricted
      deb [arch=amd64] {{ mirror_i386 }} {{ ubuntu_current }}-updates restricted
      deb [arch=amd64] {{ mirror_i386 }} {{ ubuntu_current }}-security restricted
      deb [arch=i386] {{ mirror_i386 }} {{ ubuntu_current }} main universe
      deb [arch=i386] {{ mirror_i386 }} {{ ubuntu_current }}-updates main universe
      deb [arch=i386] {{ mirror_i386 }} {{ ubuntu_current }}-security main universe

  tasks:
    - name: Ensure log directory exists on control node
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ log_dir }}"
        state: directory
        mode: '0755'

    - name: Replace /etc/apt/sources.list with private mirrors
      ansible.builtin.copy:
        dest: /etc/apt/sources.list
        content: "{{ repo_content }}"
        owner: root
        group: root
        mode: '0644'
        backup: true

    - name: Update apt cache (ignore errors)
      ansible.builtin.shell: "apt-get update -yq || true"
      register: apt_update_result
      ignore_errors: true

    - name: Save and fetch apt update log
      block:
        - ansible.builtin.copy:
            dest: /var/log/apt-update.log
            content: "{{ apt_update_result.stdout }}\n{{ apt_update_result.stderr }}"
            mode: '0644'
        - ansible.builtin.fetch:
            src: /var/log/apt-update.log
            dest: "{{ log_dir }}/apt-update.log"
            flat: true

    - name: Remove lxd package (can block upgrade)
      ansible.builtin.apt:
        name: lxd
        state: absent
        purge: true

    - name: Phase 1 - Upgrade 18.04 to 20.04
      block:
        - name: Copy auto-upgrade1.sh
          ansible.builtin.copy:
            dest: /tmp/auto-upgrade1.sh
            mode: '0755'
            content: |
              #!/bin/bash
              set -e
              export DEBIAN_FRONTEND=noninteractive
              apt-get update -yq || true
              apt-get upgrade -yq
              apt-get dist-upgrade -yq
              apt-get autoremove -yq
              apt-get install -yq update-manager-core

        - name: Run auto-upgrade1.sh
          ansible.builtin.shell: /tmp/auto-upgrade1.sh > /var/log/auto-upgrade1.log 2>&1
          async: "{{ script_execution_timeout }}"
          poll: 10
          register: auto_upgrade1_result
          ignore_errors: true

        - name: Fetch auto-upgrade1 log
          ansible.builtin.fetch:
            src: /var/log/auto-upgrade1.log
            dest: "{{ log_dir }}/auto-upgrade1.log"
            flat: true

        - name: Copy do-release1.sh
          ansible.builtin.copy:
            dest: /tmp/do-release1.sh
            mode: '0755'
            content: |
              #!/bin/bash
              set -e
              export DEBIAN_FRONTEND=noninteractive
              sed -i 's/^Prompt=.*/Prompt=lts/' /etc/update-manager/release-upgrades
              yes '' | do-release-upgrade -f DistUpgradeViewNonInteractive --frontend=DistUpgradeViewNonInteractive --mirror={{ mirror_amd64 }}
              apt-get autoremove -yq
              apt-get clean
              systemctl restart sshd

        - name: Run do-release1.sh
          ansible.builtin.shell: /tmp/do-release1.sh > /var/log/do-release1.log 2>&1
          async: "{{ script_execution_timeout }}"
          poll: 10
          register: do_release1_result
          ignore_errors: true

        - name: Wait for server to come back after upgrade
          ansible.builtin.wait_for_connection:
            delay: 10
            timeout: "{{ reboot_wait_timeout }}"

        - name: Fetch do-release1 log
          ansible.builtin.fetch:
            src: /var/log/do-release1.log
            dest: "{{ log_dir }}/do-release1.log"
            flat: true

      rescue:
        - name: Fetch journal logs on failure (phase 1)
          ansible.builtin.shell: journalctl -xe > /var/log/upgrade-phase1-failure.log
        - ansible.builtin.fetch:
            src: /var/log/upgrade-phase1-failure.log
            dest: "{{ log_dir }}/upgrade-phase1-failure.log"
            flat: true
        - ansible.builtin.fail:
            msg: "Phase 1 upgrade failed, check logs in {{ log_dir }}"

    - name: Phase 2 - Upgrade 20.04 to 22.04
      block:
        - name: Replace sources.list for 20.04 â†’ 22.04
          ansible.builtin.copy:
            dest: /etc/apt/sources.list
            content: "{{ repo_content | replace(ubuntu_current, ubuntu_next2) }}"
            mode: '0644'
            backup: true

        - name: Copy auto-upgrade2.sh
          ansible.builtin.copy:
            dest: /tmp/auto-upgrade2.sh
            mode: '0755'
            content: |
              #!/bin/bash
              set -e
              export DEBIAN_FRONTEND=noninteractive
              apt-get update -yq || true
              apt-get upgrade -yq
              apt-get dist-upgrade -yq
              apt-get autoremove -yq
              apt-get install -yq update-manager-core

        - name: Run auto-upgrade2.sh
          ansible.builtin.shell: /tmp/auto-upgrade2.sh > /var/log/auto-upgrade2.log 2>&1
          async: "{{ script_execution_timeout }}"
          poll: 10
          register: auto_upgrade2_result
          ignore_errors: true

        - name: Fetch auto-upgrade2 log
          ansible.builtin.fetch:
            src: /var/log/auto-upgrade2.log
            dest: "{{ log_dir }}/auto-upgrade2.log"
            flat: true

        - name: Copy do-release2.sh
          ansible.builtin.copy:
            dest: /tmp/do-release2.sh
            mode: '0755'
            content: |
              #!/bin/bash
              set -e
              export DEBIAN_FRONTEND=noninteractive
              sed -i 's/^Prompt=.*/Prompt=lts/' /etc/update-manager/release-upgrades
              yes '' | do-release-upgrade -f DistUpgradeViewNonInteractive --frontend=DistUpgradeViewNonInteractive --mirror={{ mirror_amd64 }}
              apt-get autoremove -yq
              apt-get clean
              systemctl restart sshd

        - name: Run do-release2.sh
          ansible.builtin.shell: /tmp/do-release2.sh > /var/log/do-release2.log 2>&1
          async: "{{ script_execution_timeout }}"
          poll: 10
          register: do_release2_result
          ignore_errors: true

        - name: Wait for server to come back after upgrade
          ansible.builtin.wait_for_connection:
            delay: 10
            timeout: "{{ reboot_wait_timeout }}"

        - name: Fetch do-release2 log
          ansible.builtin.fetch:
            src: /var/log/do-release2.log
            dest: "{{ log_dir }}/do-release2.log"
            flat: true

      rescue:
        - name: Fetch journal logs on failure (phase 2)
          ansible.builtin.shell: journalctl -xe > /var/log/upgrade-phase2-failure.log
        - ansible.builtin.fetch:
            src: /var/log/upgrade-phase2-failure.log
            dest: "{{ log_dir }}/upgrade-phase2-failure.log"
            flat: true
        - ansible.builtin.fail:
            msg: "Phase 2 upgrade failed, check logs in {{ log_dir }}"

    - name: Check final OS release
      ansible.builtin.command: lsb_release -a
      register: os_release
      changed_when: false

    - name: Print OS release information
      ansible.builtin.debug:
        msg: "{{ os_release.stdout_lines }}"
