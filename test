import subprocess
import time
import win32gui
import win32process
import psutil
import atexit
from appium import webdriver

# -------------------------
# 1. Start WinAppDriver
# -------------------------
print("Starting WinAppDriver...")
winappdriver_proc = subprocess.Popen(
    [r"C:\Program Files (x86)\Windows Application Driver\WinAppDriver.exe"],
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE,
    shell=True
)

def cleanup():
    print("Stopping WinAppDriver...")
    winappdriver_proc.terminate()

atexit.register(cleanup)

time.sleep(2)  # give WinAppDriver a moment to start

# -------------------------
# 2. Launch RMS Application
# -------------------------
print("Launching RMS Application...")
app_proc = subprocess.Popen(
    [r"C:\Path\To\RMS.exe"],  # <-- change this to your RMS exe path
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE,
    shell=True
)

time.sleep(3)  # wait for window to appear

# -------------------------
# 3. Get HWND for launched app
# -------------------------
def get_hwnd(pid):
    hwnds = []

    def callback(hwnd, _):
        _, found_pid = win32process.GetWindowThreadProcessId(hwnd)
        if found_pid == pid and win32gui.IsWindowVisible(hwnd):
            hwnds.append(hwnd)
        return True

    win32gui.EnumWindows(callback, None)
    return hwnds[0] if hwnds else None

hwnd = get_hwnd(app_proc.pid)
if not hwnd:
    raise RuntimeError("Could not find RMS app window")

hex_hwnd = hex(hwnd)
print(f"Attaching to window handle: {hex_hwnd}")

# -------------------------
# 4. Attach to app with WinAppDriver
# -------------------------
caps = {
    "platformName": "Windows",
    "deviceName": "WindowsPC",
    "appTopLevelWindow": hex_hwnd
}

driver = webdriver.Remote(
    command_executor="http://127.0.0.1:4723",
    desired_capabilities=caps
)

time.sleep(2)

# -------------------------
# 5. Automate Login Flow
# -------------------------
print("Performing login flow...")

# Example (replace with your Inspect tool details!)
driver.find_element("accessibility id", "EnvComboBox").send_keys("UAT")
driver.find_element("accessibility id", "UserNameTextBox").send_keys("your_user")
driver.find_element("accessibility id", "PasswordTextBox").send_keys("your_pass")
driver.find_element("accessibility id", "LoginButton").click()

print("Login flow completed.")

# -------------------------
# 6. Keep app open for verification
# -------------------------
time.sleep(5)
driver.quit()
