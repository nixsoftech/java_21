import os
import subprocess
import time
import win32gui
import win32process
import win32con
import win32api


# -------------------------
# Find window handle by PID
# -------------------------
def get_hwnd(pid):
    hwnds = []

    def callback(hwnd, _):
        # Get process id for this window
        _, found_pid = win32process.GetWindowThreadProcessId(hwnd)
        if found_pid == pid and win32gui.IsWindowVisible(hwnd):
            hwnds.append(hwnd)
        return True

    win32gui.EnumWindows(callback, None)
    return hwnds[0] if hwnds else None


# -------------------------
# Launch RMS application
# -------------------------
print("Launching RMS Application...")
app_path = r"C:\Path\To\RMS.exe"   # <-- update this
app_proc = subprocess.Popen(app_path)

# Wait for process to start
time.sleep(3)

# Get window handle
hwnd = get_hwnd(app_proc.pid)
if not hwnd:
    raise Exception("Could not find RMS application window.")

# Bring window to foreground
win32gui.ShowWindow(hwnd, win32con.SW_RESTORE)
win32gui.SetForegroundWindow(hwnd)


# -------------------------
# Automate login (example)
# -------------------------
time.sleep(1)

# Type username
username = "testuser"
for ch in username:
    win32api.SendMessage(hwnd, win32con.WM_CHAR, ord(ch), 0)
time.sleep(0.5)

# Press TAB to move to password field
win32api.SendMessage(hwnd, win32con.WM_KEYDOWN, win32con.VK_TAB, 0)
win32api.SendMessage(hwnd, win32con.WM_KEYUP, win32con.VK_TAB, 0)
time.sleep(0.5)

# Type password
password = "P@ssw0rd"
for ch in password:
    win32api.SendMessage(hwnd, win32con.WM_CHAR, ord(ch), 0)
time.sleep(0.5)

# Press ENTER to login
win32api.SendMessage(hwnd, win32con.WM_KEYDOWN, win32con.VK_RETURN, 0)
win32api.SendMessage(hwnd, win32con.WM_KEYUP, win32con.VK_RETURN, 0)

print("Login flow completed.")
