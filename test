#!/bin/bash
# ============================================
# Script: sync-ubuntu-dists-http.sh
# Purpose: Dry-run & sync selected Ubuntu dists over HTTP
# ============================================

# Base URL of the official Ubuntu mirror
BASE_URL="http://archive.ubuntu.com/ubuntu"

# Local path where mirror is stored
LOCAL_PATH="/ubuntu_packages/ubuntu/mirror/archive.ubuntu.com/ubuntu"

# Log files
LOG_DIR="/var/log/ubuntu_mirror"
mkdir -p "$LOG_DIR"
DRYRUN_LOG="$LOG_DIR/dryrun_$(date +%F_%H-%M-%S).log"
DOWNLOAD_LOG="$LOG_DIR/download_$(date +%F_%H-%M-%S).log"

# List of distributions to check/sync
DISTS="bionic bionic-updates bionic-security \
focal focal-updates focal-security \
jammy jammy-updates jammy-security"

echo "ğŸ” Starting dry-run check for selected distributions..."
echo "===================================================" | tee -a "$DRYRUN_LOG"

# Dry-run: Check missing files using wget --spider
for dist in $DISTS; do
  echo -e "\nğŸ” Checking $dist ..." | tee -a "$DRYRUN_LOG"
  wget --spider -r -np -nH --cut-dirs=1 -R "index.html*" \
       "$BASE_URL/$dist/" 2>&1 | tee -a "$DRYRUN_LOG" | grep -i "404"
done

echo -e "\nâœ… Dry-run check completed. Review 404 errors above." | tee -a "$DRYRUN_LOG"

# Ask user if they want to download missing files
read -p "Do you want to download missing files now? (y/n): " confirm

if [[ "$confirm" =~ ^[Yy]$ ]]; then
    echo -e "\nğŸš€ Starting real download..." | tee -a "$DOWNLOAD_LOG"
    for dist in $DISTS; do
      echo -e "\nâ¬‡ï¸ Downloading $dist ..." | tee -a "$DOWNLOAD_LOG"
      wget -c -r -np -nH --cut-dirs=1 -R "index.html*" \
           -P "$LOCAL_PATH" "$BASE_URL/$dist/" 2>&1 | tee -a "$DOWNLOAD_LOG"
    done
    echo -e "\nğŸ‰ Download completed successfully." | tee -a "$DOWNLOAD_LOG"
else
    echo -e "\nâŒ Download skipped by user." | tee -a "$DOWNLOAD_LOG"
fi
