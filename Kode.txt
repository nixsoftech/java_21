#!/bin/bash
set -e

# Non-interactive flags
export DEBIAN_FRONTEND=noninteractive
export NEEDRESTART_MODE=a
export APT_LISTCHANGES_FRONTEND=none

# Redirect all output to log
exec > /tmp/focal_upgrade.log 2>&1

echo "=== Step 0: Starting focal upgrade ==="

# Try removing LXD and LXD-client via apt
echo "Attempting to remove lxd and lxd-client via apt..."
if ! apt-get remove --purge -y lxd lxd-client; then
    echo "apt remove failed. Forcing removal with dpkg..."
    dpkg --remove --force-remove-reinstreq lxd || true
    dpkg --remove --force-remove-reinstreq lxd-client || true
fi

# Clean leftover files
rm -rf /var/lib/lxd /etc/lxd || true
apt-get clean || true

##############################################
# Step 1: Upgrade 18.04 (bionic) -> 20.04 (focal)
##############################################
echo "=== Step 1: Writing focal repositories ==="
cat > /etc/apt/sources.list <<EOF
# focal repositories (amd64)
deb [arch=amd64] http://10.13.0.88:8080/ubuntu focal main universe
deb [arch=amd64] http://10.13.0.88:8080/ubuntu focal-updates main universe
deb [arch=amd64] http://10.13.0.88:8080/ubuntu focal-security main universe

# focal repositories (i386)
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu focal main universe
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu focal-updates main universe
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu focal-security main universe

# restricted packages (amd64)
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu focal restricted
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu focal-updates restricted
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu focal-security restricted
EOF

echo "=== Step 2: Updating and upgrading to focal ==="
apt-get update -o Acquire::Check-Valid-Until=false -yq || true
apt-get upgrade -yq \
  -o Dpkg::Options::="--force-confdef" \
  -o Dpkg::Options::="--force-confold"

apt-get dist-upgrade -yq \
  -o Dpkg::Options::="--force-confdef" \
  -o Dpkg::Options::="--force-confold"

apt-get autoremove -yq || true
apt-get autoclean -yq || true

# Restart SSH so Ansible can reconnect
echo "=== Step 3: Restarting SSH service ==="
systemctl restart ssh || systemctl restart sshd || true

echo "Step 4: Focal upgrade completed."
