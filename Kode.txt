âœ… 1. Locate Your apt-mirror Directory

Check the apt-mirror configuration file:

grep '^set base_path' /etc/apt/mirror.list


By default, apt-mirror stores files under:

/var/spool/apt-mirror/mirror/<mirror-hostname>/ubuntu/


Example:

/var/spool/apt-mirror/mirror/archive.ubuntu.com/ubuntu/

âœ… 2. Check Repository Structure

Make sure all required distributions are present:

ls -1 /var/spool/apt-mirror/mirror/archive.ubuntu.com/ubuntu/dists/


You should see folders like:

bionic
bionic-updates
bionic-security
focal
focal-updates
focal-security
jammy
jammy-updates
jammy-security


If some are missing, you must sync again.

âœ… 3. Test the Repository from a Client

From a client machine, run:

curl -I http://<your-mirror-ip>:8080/ubuntu/dists/jammy/InRelease


You should get HTTP/1.1 200 OK.
Then run:

sudo apt-get clean
sudo apt-get update


If you see no 404 Not Found errors, your repo is fine.

âœ… 4. Dry-Run Rsync (Check for Missing Files)

Compare your mirror with the official Ubuntu archive without downloading:

rsync -av --dry-run rsync://archive.ubuntu.com/ubuntu/ /var/spool/apt-mirror/mirror/archive.ubuntu.com/ubuntu/


--dry-run â†’ Shows what files would be downloaded/updated.

-a â†’ Preserves permissions and timestamps.

-v â†’ Verbose output.

If you see many files listed, your mirror is missing data.

âœ… 5. Synchronize Missing Files (Real Run)

Once you're satisfied with the dry-run result, run rsync without --dry-run:

rsync -av rsync://archive.ubuntu.com/ubuntu/ /var/spool/apt-mirror/mirror/archive.ubuntu.com/ubuntu/


This will:

Download only missing or changed files

Bring your mirror fully up to date

âœ… 6. (Optional) Use a Nearby Mirror

For faster sync, find a mirror closer to your location:
ğŸ”— https://launchpad.net/ubuntu/+archivemirrors

Then use it in rsync:

rsync -av rsync://mirror.cse.iitk.ac.in/ubuntu/ /var/spool/apt-mirror/mirror/archive.ubuntu.com/ubuntu/

âœ… 7. Automate with Cron

To keep your mirror updated regularly, add a cron job:

sudo crontab -e


Example entry (sync every night at 2 AM):

0 2 * * * rsync -az rsync://archive.ubuntu.com/ubuntu/ /var/spool/apt-mirror/mirror/archive.ubuntu.com/ubuntu/ > /var/log/apt-mirror-rsync.log 2>&1

ğŸ› ï¸ Example: Shell Script for Easy Sync

Save as /usr/local/bin/sync-apt-mirror.sh:

#!/bin/bash
MIRROR_PATH="/var/spool/apt-mirror/mirror/archive.ubuntu.com/ubuntu/"
SOURCE="rsync://archive.ubuntu.com/ubuntu/"

echo "ğŸ” Running dry-run check..."
rsync -av --dry-run $SOURCE $MIRROR_PATH | tee /tmp/apt-mirror-check.log

echo "âœ… Review the list above."
read -p "Do you want to perform actual sync? (y/n): " confirm

if [[ $confirm == "y" || $confirm == "Y" ]]; then
    echo "ğŸš€ Starting sync..."
    rsync -av $SOURCE $MIRROR_PATH
    echo "ğŸ‰ Sync completed successfully."
else
    echo "âŒ Sync aborted by user."
fi


Make it executable:

sudo chmod +x /usr/local/bin/sync-apt-mirror.sh


Run manually:

sudo /usr/local/bin/sync-apt-mirror.sh


âœ… After sync, always test with apt-get update on a client machine before using the repo for upgrades.
