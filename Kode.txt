#!/bin/bash
# ============================================
# Script: sync-ubuntu-dists-http.sh
# Purpose: Automatically download selected Ubuntu dists over HTTP
#          with success/failure messages
# ============================================

# Base URL of the official Ubuntu mirror (include /dists/)
BASE_URL="http://archive.ubuntu.com/ubuntu/dists"

# Local path where mirror is stored
LOCAL_PATH="/ubuntu_packages/ubuntu/mirror/archive.ubuntu.com/ubuntu"

# Log files
LOG_DIR="/var/log/ubuntu_mirror"
mkdir -p "$LOG_DIR"
DOWNLOAD_LOG="$LOG_DIR/download_$(date +%F_%H-%M-%S).log"

# List of distributions to check/sync
DISTS="bionic bionic-updates bionic-security \
focal focal-updates focal-security \
jammy jammy-updates jammy-security"

echo "üöÄ Starting download of selected Ubuntu distributions..."
echo "===================================================" | tee -a "$DOWNLOAD_LOG"

# Initialize status variable
ALL_SUCCESS=true

# Download each distribution
for dist in $DISTS; do
  echo -e "\n‚¨áÔ∏è Downloading $dist ..." | tee -a "$DOWNLOAD_LOG"
  
  wget -c -r -np -nH --cut-dirs=2 -R "index.html*" \
       -P "$LOCAL_PATH" "$BASE_URL/$dist/" 2>&1 | tee -a "$DOWNLOAD_LOG"
  
  # Check if wget succeeded
  if [ ${PIPESTATUS[0]} -ne 0 ]; then
    echo "‚ùå $dist download FAILED or incomplete!" | tee -a "$DOWNLOAD_LOG"
    ALL_SUCCESS=false
  else
    echo "‚úÖ $dist download SUCCESS!" | tee -a "$DOWNLOAD_LOG"
  fi
done

# Final overall status
echo -e "\n===================================================" | tee -a "$DOWNLOAD_LOG"
if [ "$ALL_SUCCESS" = true ]; then
    echo "üéâ ALL downloads completed SUCCESSFULLY." | tee -a "$DOWNLOAD_LOG"
else
    echo "‚ö†Ô∏è Some downloads FAILED or are incomplete. Check the log for details: $DOWNLOAD_LOG" | tee -a "$DOWNLOAD_LOG"
fi
