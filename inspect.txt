#!/bin/bash
set -e

# Non-interactive flags
export DEBIAN_FRONTEND=noninteractive
export NEEDRESTART_MODE=a
export APT_LISTCHANGES_FRONTEND=none

# Clean any previous package cache
apt-get clean || true
rm -rf /var/lib/apt/lists/* || true

##############################################
# Step 1: Configure Jammy repositories
##############################################
echo "=== Step 1: Writing Jammy repositories ==="
cat > /etc/apt/sources.list <<EOF
# jammy repositories (amd64)
deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy main universe
deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy-updates main universe
deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy-security main universe

# jammy repositories (i386)
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu jammy main universe
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu jammy-updates main universe
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu jammy-security main universe

# restricted packages (amd64)
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu jammy restricted
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu jammy-updates restricted
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu jammy-security restricted
EOF

##############################################
# Step 2: Update package lists
##############################################
echo "=== Step 2: Updating package lists ==="
apt-get update -o Acquire::Check-Valid-Until=false -yq || true

##############################################
# Step 3: Install release upgrader core (optional, for completeness)
##############################################
echo "=== Step 3: Installing release upgrader core ==="
apt-get install -y ubuntu-release-upgrader-core || true

##############################################
# Step 4: Perform full upgrade
##############################################
echo "=== Step 4: Performing full upgrade to Jammy ==="
apt-get full-upgrade -yq \
  -o Dpkg::Options::="--force-confdef" \
  -o Dpkg::Options::="--force-confold"

##############################################
# Step 5: Cleanup
##############################################
echo "=== Step 5: Autoremove and autoclean ==="
apt-get autoremove -yq || true
apt-get autoclean -yq || true

echo "=== Jammy upgrade completed successfully ==="
