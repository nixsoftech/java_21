#!/bin/bash
set -e

# -----------------------------
# Offline Jammy Upgrade Script
# -----------------------------

# Non-interactive flags
export DEBIAN_FRONTEND=noninteractive
export NEEDRESTART_MODE=a
export APT_LISTCHANGES_FRONTEND=none

echo "=== Step 0: Backup current sources.list ==="
cp /etc/apt/sources.list /etc/apt/sources.list.bak

echo "=== Step 1: Disable AppStream and Snap hooks ==="
[ -f /etc/apt/apt.conf.d/50appstream ] && mv /etc/apt/apt.conf.d/50appstream /etc/apt/apt.conf.d/50appstream.disabled
[ -f /etc/apt/apt.conf.d/20snapd.conf ] && mv /etc/apt/apt.conf.d/20snapd.conf /etc/apt/apt.conf.d/20snapd.conf.disabled

echo "=== Step 2: Hold snap-related packages ==="
apt-mark hold snapd firefox

echo "=== Step 3: Clean old package lists and cache ==="
rm -rf /var/lib/apt/lists/*
apt-get clean
apt-get autoclean

echo "=== Step 4: Configure Jammy repositories ==="
cat > /etc/apt/sources.list <<EOF
# jammy repositories (amd64)
deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy main universe
deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy-updates main universe
deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy-security main universe

# jammy repositories (i386)
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu jammy main universe
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu jammy-updates main universe
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu jammy-security main universe

# restricted packages (amd64)
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu jammy restricted
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu jammy-updates restricted
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu jammy-security restricted
EOF

echo "=== Step 5: Update package lists from local repo ==="
apt-get update -o Acquire::Check-Valid-Until=false -yq || true

echo "=== Step 6: Upgrade packages ==="
apt-get upgrade -yq \
  -o Dpkg::Options::="--force-confdef" \
  -o Dpkg::Options::="--force-confold"

apt-get dist-upgrade -yq \
  -o Dpkg::Options::="--force-confdef" \
  -o Dpkg::Options::="--force-confold"

echo "=== Step 7: Clean up after upgrade ==="
apt-get autoremove -yq
apt-get autoclean -yq

echo "=== Jammy offline upgrade completed successfully ==="
