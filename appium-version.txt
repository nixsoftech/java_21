#!/bin/bash
set -e

# Non-interactive flags
export DEBIAN_FRONTEND=noninteractive
export NEEDRESTART_MODE=a
export APT_LISTCHANGES_FRONTEND=none

# Redirect all output to log
exec > /tmp/jammy_upgrade.log 2>&1

echo "=== Step 0: Starting jammy upgrade ==="

##############################################
# Step 2: Upgrade 20.04 (focal) -> 22.04 (jammy)
##############################################
echo "=== Step 1: Writing jammy repositories ==="
cat > /etc/apt/sources.list <<EOF
# jammy repositories (amd64)
deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy main universe
deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy-updates main universe
deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy-security main universe

# jammy repositories (i386)
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu jammy main universe
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu jammy-updates main universe
deb [arch=i386] http://10.13.0.90/ubuntu/ubuntu jammy-security main universe

# restricted packages (amd64)
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu jammy restricted
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu jammy-updates restricted
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu jammy-security restricted
EOF

echo "=== Step 2: Updating and upgrading to jammy ==="
apt-get update -o Acquire::Check-Valid-Until=false -yq || true
apt-get upgrade -yq \
  -o Dpkg::Options::="--force-confdef" \
  -o Dpkg::Options::="--force-confold"

apt-get dist-upgrade -yq \
  -o Dpkg::Options::="--force-confdef" \
  -o Dpkg::Options::="--force-confold"

apt-get autoremove -yq || true
apt-get autoclean -yq || true

echo "=== Step 4: Jammy upgrade completed. Reboot can be triggered manually by Ansible. ==="
