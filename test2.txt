---
- name: Offline Ubuntu LTS upgrade 18.04 -> 20.04 -> 22.04
  hosts: all
  become: true
  vars:
    reboot_wait_timeout: 3600   # 60 minutes, adjust if needed
    log_dir: "{{ playbook_dir }}/upgrade-logs/{{ inventory_hostname }}"

  tasks:

    - name: Ensure log directory exists on control node
      delegate_to: localhost
      file:
        path: "{{ log_dir }}"
        state: directory
        mode: '0755'

    - name: Backup /etc to /etc_bkp before upgrade
      shell: |
        if [ ! -d /etc_bkp ]; then
          cp -a /etc /etc_bkp
        fi
      changed_when: false

    - name: Copy focal.sh to /tmp/ on target
      copy:
        src: focal.sh
        dest: /tmp/focal.sh
        mode: '0755'

    - name: Copy jammy.sh to /tmp/ on target
      copy:
        src: jammy.sh
        dest: /tmp/jammy.sh
        mode: '0755'

    - name: Detect current Ubuntu version
      command: lsb_release -sc
      register: current_release
      changed_when: false

    - name: Show current release
      debug:
        msg: "Current release: {{ current_release.stdout }}"

    - name: Run focal.sh if OS is 18.04 (bionic)
      shell: "/tmp/focal.sh > /tmp/focal_upgrade.log 2>&1"
      async: 7200
      poll: 0
      when: current_release.stdout == "bionic"
      register: focal_job

    - name: Wait for focal.sh to complete and host to come back online
      async_status:
        jid: "{{ focal_job.ansible_job_id }}"
      register: focal_status
      until: focal_status.finished
      retries: 120
      delay: 60
      when: current_release.stdout == "bionic"

    - name: Wait for SSH to come back (after focal upgrade)
      wait_for_connection:
        delay: 10
        timeout: "{{ reboot_wait_timeout }}"
      when: current_release.stdout == "bionic"

    - name: Fetch focal upgrade log to control node
      fetch:
        src: /tmp/focal_upgrade.log
        dest: "{{ log_dir }}/focal_upgrade.log"
        flat: yes
      when: current_release.stdout == "bionic"

    - name: Detect Ubuntu version after first upgrade
      command: lsb_release -sc
      register: release_after_first
      changed_when: false

    - name: Show release after first upgrade
      debug:
        msg: "Release after first upgrade: {{ release_after_first.stdout }}"

    - name: Run jammy.sh if OS is 20.04 (focal)
      shell: "/tmp/jammy.sh > /tmp/jammy_upgrade.log 2>&1"
      async: 7200
      poll: 0
      when: release_after_first.stdout == "focal" or current_release.stdout == "focal"
      register: jammy_job

    - name: Wait for jammy.sh to complete and host to come back online
      async_status:
        jid: "{{ jammy_job.ansible_job_id }}"
      register: jammy_status
      until: jammy_status.finished
      retries: 120
      delay: 60
      when: release_after_first.stdout == "focal" or current_release.stdout == "focal"

    - name: Wait for SSH to come back (after jammy upgrade)
      wait_for_connection:
        delay: 10
        timeout: "{{ reboot_wait_timeout }}"
      when: release_after_first.stdout == "focal" or current_release.stdout == "focal"

    - name: Fetch jammy upgrade log to control node
      fetch:
        src: /tmp/jammy_upgrade.log
        dest: "{{ log_dir }}/jammy_upgrade.log"
        flat: yes
      when: release_after_first.stdout == "focal" or current_release.stdout == "focal"

    - name: Confirm final Ubuntu version is 22.04 (jammy)
      command: lsb_release -sc
      register: final_release
      changed_when: false

    - name: Show final release output
      debug:
        msg: "Final Ubuntu release: {{ final_release.stdout }}"
