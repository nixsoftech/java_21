#!/bin/bash
set -e

# Non-interactive environment
export DEBIAN_FRONTEND=noninteractive
export NEEDRESTART_MODE=a
export APT_LISTCHANGES_FRONTEND=none

echo "=== Step 1: Writing focal repositories to /etc/apt/sources.list ==="
cat > /etc/apt/sources.list <<EOF
# Private Repository
deb [arch=amd64] http://10.13.0.88:8080/ubuntu focal main universe
deb [arch=amd64] http://10.13.0.88:8080/ubuntu focal-updates main universe
deb [arch=amd64] http://10.13.0.88:8080/ubuntu focal-security main universe
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu focal restricted
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu focal-updates restricted
deb [arch=amd64] http://10.13.0.90/ubuntu/ubuntu focal-security restricted
deb [arch=i386]  http://10.13.0.90/ubuntu/ubuntu focal main universe
deb [arch=i386]  http://10.13.0.90/ubuntu/ubuntu focal-updates main universe
deb [arch=i386]  http://10.13.0.90/ubuntu/ubuntu focal-security main universe
EOF

echo "=== Step 2: Updating and upgrading to focal ==="
apt-get update -yq || true

apt-get upgrade -yq \
  -o Dpkg::Options::="--force-confdef" \
  -o Dpkg::Options::="--force-confold"

apt-get dist-upgrade -yq \
  -o Dpkg::Options::="--force-confdef" \
  -o Dpkg::Options::="--force-confold"

apt-get autoremove -yq || true
apt-get autoclean -yq || true

echo "=== Step 3: Rebooting system ==="
reboot
