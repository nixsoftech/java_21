def handle_popup(app, expected_substring=None, auto_id_to_click=None, timeout=15):
    """Wait for a popup and click using AutomationId if provided."""
    try:
        popup = app.window(title_re=".*")
        popup.wait("visible", timeout=timeout)
        popup_text = popup.window_text().strip()
        logger.info(f"Popup detected: '{popup_text}'")

        if expected_substring and expected_substring.lower() not in popup_text.lower():
            logger.warning(f"Popup text does not contain expected '{expected_substring}', proceeding anyway...")

        if auto_id_to_click:
            try:
                btn = popup.child_window(auto_id=auto_id_to_click, control_type="Button")
                btn.wait("enabled", timeout=5).click_input()
                logger.info(f"Clicked button with AutomationId={auto_id_to_click}")
            except Exception as e:
                logger.error(f"Failed to click button with AutomationId={auto_id_to_click}: {e}")
        return True

    except TimeoutError:
        logger.info(f"No popup appeared within {timeout}s.")
        return False
